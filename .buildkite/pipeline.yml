env:
  IMAGE_NAME: "be-test-image"

steps:
  - label: "Checkout and List Files"
    command:
      - "ls -la"
      - "pwd"
      - "echo 'Hello, world!' > myfile.txt"
      - "cat myfile.txt"
  
  - label: install docker on runner 
    plugins:
      - docker#v3.2.0:
          image: "node:22"
          workdir: /app
          volumes:
            - /var/run/docker.sock
    command: 
      - "yarn install && yarn" 
      - "docker build -t $IMAGE_NAME ."

  - label: "store files in artifacts"
    command: 
      - "echo 'hi shuvo' > artifacts.txt"
      - "buildkite-agent artifact upload 'artifacts.txt'"
      - "docker --version"
    artifact_paths: 
       - artifacts.txt
    agents:
      queue: "default"


  - block: "Approval Step"
    prompt: "Please approve to proceed with Docker image build"
    fields:
      - text: "Reason for approval"
        key: "approval_reason"
        hint: "Enter the reason for approving this step"
        required: true

  - label: "Build docker image"
    command: 
      - "cd services/BE"
      - "ls -la"
      -  "docker build -t $IMAGE_NAME ."
      - "docker images" 

  - wait

  - label: "cleanup created image"
    command:
      - "docker rmi $IMAGE_NAME:latest"
      - "docker images"

    agents:
      queue: "default"
